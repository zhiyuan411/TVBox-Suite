#! env python
# -*- coding: utf-8 -*-
 
from flask import Flask, request, session, Response, send_file, abort, jsonify
from urllib.parse import urlparse, unquote
from user_agents import parse  # 需要安装：suod pip3 install user-agents
import pwd
import os
import datetime
import re
import base64
import requests
import json
import subprocess

 
app = Flask(__name__)
app.config['SESSION_TYPE'] = 'filesystem'
app.config['SECRET_KEY'] = 'your-secret-key-here'
app.debug = True
 
 
@app.route('/')
def hello_world():
    return '<h1 style="color: green;">你好，flask!</h1>'

@app.route('/append-input.do', methods=['POST'])
def append_to_input():
    """将前端文本框内容去重合并到 input.txt"""
    INPUT_FILE = '/home/ecs-user/TVBox-Suite/script/merge-sources/input.txt'
    # 新增：定义无效历史记录文件路径
    INVALID_HISTORY_FILE = '/var/www/html/private/input.txt.invalid-json-history'

    try:
        # 1. 获取前端内容 (兼容 JSON 和 Form-Data)
        content = ""
        if request.is_json:
            content = request.json.get('content', '')
        else:
            content = request.form.get('content', '')

        if not content:
            return jsonify({"code": 400, "msg": "内容不能为空"}), 400

        # 2. 处理输入内容：使用正则提取 URL
        processed_input = []
        # 正则表达式：匹配 http:// 或 https:// 开头，直到遇到空白字符或行尾
        url_pattern = re.compile(r'https?://\S+')

        for line in content.splitlines():
            stripped_line = line.strip()
            if not stripped_line:
                continue

            # 查找所有匹配的 URL
            matches = url_pattern.findall(stripped_line)
            if matches:
                # 将找到的 URL 添加到列表（可能一行有多个，也一并提取）
                processed_input.extend(matches)

        # 3. 读取现有文件内容到 Set (用于快速去重)
        existing_lines = set()
        try:
            with open(INPUT_FILE, 'r', encoding='utf-8') as f:
                for line in f:
                    stripped = line.strip()
                    if stripped:
                        existing_lines.add(stripped)
        except FileNotFoundError:
            # 文件不存在则视为空
            pass

        # 新增：读取无效历史记录文件内容
        invalid_history_lines = set()
        try:
            with open(INVALID_HISTORY_FILE, 'r', encoding='utf-8') as f:
                for line in f:
                    stripped = line.strip()
                    if stripped:
                        invalid_history_lines.add(stripped)
        except FileNotFoundError:
            # 文件不存在则视为空
            pass

        # 4. 计算需要新增的行 (先对 processed_input 本身去重，防止同一批输入里有重复)
        unique_processed = list(dict.fromkeys(processed_input)) # 保留顺序去重
        # 修改：过滤条件改为既不在主文件，也不在无效历史文件中
        new_lines_to_add = [
            line for line in unique_processed 
            if line not in existing_lines and line not in invalid_history_lines
        ]

        # 5. 追加写入文件
        if new_lines_to_add:
            # 确保目录存在
            os.makedirs(os.path.dirname(INPUT_FILE), exist_ok=True)
            with open(INPUT_FILE, 'a', encoding='utf-8') as f:
                for line in new_lines_to_add:
                    f.write(f"{line}\n")

        # 6. 返回 JSON 结果
        return jsonify({
            "code": 200,
            "msg": "处理成功",
            "data": {
                "total_received": len(unique_processed),  # 收到的有效链接数
                "total_added": len(new_lines_to_add),    # 实际新增的链接数
                "total_duplicate": len(unique_processed) - len(new_lines_to_add), # 重复/忽略数
                "added_lines": new_lines_to_add          # 具体新增了哪些
            }
        })

    except Exception as e:
        return jsonify({"code": 500, "msg": f"服务器内部错误: {str(e)}"}), 500

@app.route('/update.do', methods=['GET'])
def trigger_update():
    script_dir = '/home/ecs-user/TVBox-Suite/script/merge-sources'
    script_name = './update.sh'
    log_path = '/home/ecs-user/TVBox-Suite/script/merge-sources/web-task.log'
    err_log_path = '/home/ecs-user/TVBox-Suite/script/merge-sources/web-task-error.log'

    # 指定要切换到的目标用户
    target_user = 'ecs-user'
    try:
        user_info = pwd.getpwnam(target_user)
        uid = user_info.pw_uid
        gid = user_info.pw_gid
    except KeyError:
        return jsonify({"code": 500, "msg": f"User '{target_user}' not found."}), 500

    def drop_privileges():
        # 先设置组 ID，再设置用户 ID（顺序不能反）
        os.setgid(gid)
        os.setuid(uid)

    try:
        f_log = open(log_path, 'a+', encoding='utf-8')
        f_err = open(err_log_path, 'a+', encoding='utf-8')

        subprocess.Popen(
            [script_name],
            cwd=script_dir,
            stdout=f_log,
            stderr=f_err,
            start_new_session=True,
            preexec_fn=drop_privileges  # 关键：在子进程中切换用户
        )
        return jsonify({"code": 200, "msg": "Update task started successfully."})
    except Exception as e:
        return jsonify({"code": 500, "msg": f"Failed to start task: {str(e)}"}), 500


@app.route('/add.do', methods=['GET'])
def add_to_list():
    # 定义白名单和黑名单文件路径
    whitelist_path = '/home/ecs-user/TVBox-Suite/script/random-sites/whitelist.txt'
    blacklist_path = '/home/ecs-user/TVBox-Suite/script/random-sites/blacklist.txt'
    
    # 初始化返回消息
    response_messages = []

    for param, value in request.args.items():
        if not value:
            return '<h1 style="color: red;">缺少必要参数。</h1>', 400

        try:

            # 检查值是否已经存在于相应的文件中
            file_path = None
            message_prefix = ""

            if param in ['w', 'white', 'whitelist']:
                file_path = whitelist_path
                message_prefix = "白名单"
            elif param in ['b', 'black', 'blacklist']:
                file_path = blacklist_path
                message_prefix = "黑名单"
            else:
                return f'<h1 style="color: red;">无效参数: {param}</h1>', 400

            # 检查值是否已经存在
            value_exists = False
            try:
                with open(file_path, 'r') as file:
                    value_exists = any(line.strip() == value for line in file)
            except FileNotFoundError:
                pass  # 文件不存在时，默认值不存在

            if value_exists:
                response_messages.append(f'<h1 style="color: green;">"{value}" 已经存在于 {message_prefix} 中。</h1>')
            else:
                with open(file_path, 'a') as f:
                    f.write(f"{value}\n")
                response_messages.append(f'<h1 style="color: green;">已添加 "{value}" 到 {message_prefix}。</h1>')

        except Exception as e:
            return f'<h1 style="color: red;">处理参数 "{param}" 时发生错误: {e}</h1>', 500

    # 如果没有任何有效的参数被处理，则返回错误信息
    if not response_messages:
        return '<h1 style="color: red;">没有提供有效参数。</h1>', 400

    # 返回所有成功处理的消息
    return "\n".join(response_messages), 200

 
 
if __name__ == '__main__':
    # app.secret_key = 'your-secret-key-here'
    app.run()
